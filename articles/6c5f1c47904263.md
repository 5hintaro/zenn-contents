---
title: "Amplify Gen2 のガイドライン"
emoji: "⭐️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["amplify", "amplifygen2"]
published: false
---

Amplify に挑む勇者たちのためのガイドラインです。簡単にまとめたものなので、詳細は公式ドキュメントを参照してください。とはいっても公式ドキュメントは不完全なのが Amplify の現状なので、ぶっちゃけソースコードを参照してください。

主に最低限、これを抑えておけばイージーに  Amplify Gen2 を使えるのでは？と思いながら書いています。

# Amplify Gen2 はどう変わったのか？

- CDK が使えるようになった
  - AWSリソースを Typescript で定義できるようになったので、もうCLIでリソース追加とかしなくていい
  - CDK を理解している人は馴染みやすい
  - CDK とイコールではなく、Amplify 用の L2, L3 コンストラクトが用意されたイメージを持つといいです
  - カスタムで純粋な CDK を書くこともできます
- Amplify CLI が新しくなった（まったく違うものになりました）
- Backend Environment がなくなった
  - Frontend はいつも通りですが、インフラを管理するのが CLI から CDK に変わった関係で Backend Environment はなくなりました
  - その証拠に Gen2 をデプロイしたあと、Branch settings を見ると Backend Environment がなくなっています

だいたいこの辺を理解していればOKです。

![Amplify Gen2 のアーキテクチャ](https://storage.googleapis.com/zenn-user-upload/0f251f25292e-20250227.webp)

参考：https://docs.amplify.aws/vue/how-amplify-works/concepts/

## それでも変わらないもの

- Amplify のフロントエンドはいつも通り
- Amplify のコンソールはいつも通り
  - Gen1 と Gen2 分けてくれた方が個人的には嬉しかった
- セキュリティ面は自己責任
- CloudFormation の仕組み
  - 個人的にネストされたスタックは認知負荷高いので改善してほしかった
  - スタック名はどう頑張っても変えることができないので、相変わらずリソース名がわかりにくい
    - リソースに紐づいているタグを見るとわかるので、それを見るといいです

Architecture as Code を謳っている Amplify ですが、ベストプラクティスの実践やセキュリティ面は自己責任のままです。そこまで面倒見てくれないので、そこは注意してください。

## 惜しいなと思うところ

- CDK 使っているのに diff 機能はない
- 相変わらずドキュメントが読みにくい
  - ソースコード見るの疲れる
  - どんな生成AIでも Amplify Gen2 については正しい回答を得ることができない
    - 私は新しい生成AIが出るたびに Amplify Gen2 について質問しています
    - この問題に正確に回答をくれる生成AIが現れたときが、AGI の誕生です（暴論）

# 各リソースの使い方

どこのファイルで管理しているかを説明します。

- amplify/auth/resource.ts - Cognito
- amplify/data/resource.ts - AppSync
  - Gen1 と同じでここで定義したコードをもとに DynamoDB が作られます
- amplify/function/*/resource.ts - Lambda
- amplify/storage/resource.ts - S3
- amplify/backend.ts - デプロイするやつすべてを定義
  - 私は API Gateway, DyanmoDB Streams などはここで定義しました
  - 別のファイルで定義してもいいです

## 注意してほしいこと

- Lambda関数がデプロイ方法が変わりました、Typescript を前提にしているので Javascript のコードもバンドルされてしまいます
  - これを機に Typescript に移行しましょう
- AppSync の定義方法が変わりました、なので権限関連の記述は注意してください
  - [こちら](https://docs.amplify.aws/vue/build-a-backend/data/customize-authz/#available-authorization-strategies)を参考にしてください


# Gen1 -> Gen2 への移行

マイグレーションツール作っているらしいですが、現状は個人の気合いでやるしかありません。

各リソースの移行方法をおさらいしましょう。

- Cognito
  - インポートできます
    - Gen1 でリンクを切ったあとに CDK で参照するコードを定義してください
  - 新しく作り直す
    - 移行戦略は通常の Cognito の方法と同じです
- AppSync
  - Gen2 に書き直すしかない
- Lambda
  - Gen2 に書き直すしかない
- S3
  - インポートできます
    - Gen1 でリンクを切ったあとに CDK で参照するコードを定義してください
  - 新しく作り直す
    - レプリケーションして、終わったら任意のタイミングでリンクを切る流れになると思います
- DynamoDB
  - Gen2 に書き直すしかない（AppSyncに依存しているので）
  - 構築後はレプリケーションしてお引越ししましょう
- API Gateway
  - Gen2 に書き直すしかない

# ちょっと役にたつかもしれない TIPS

- インフラをデプロイしたいとき、特定のブランチに push して自動デプロイが基本ですが、CLIでさくっとやりたい場合は以下のコマンドを実行してください
  - `npx ampx pipeline-deploy --branch $BRANCH_NAME --app-id $AWS_APP_ID --outputs-version 1`
    - `--outputs-version` は新しい Config ファイルを使ってくれる 1 に設定しておきましょう 
  - 参考：https://docs.amplify.aws/react/reference/cli-commands/#npx-ampx-pipeline-deploy

# 参考にしてほしいドキュメント

- https://github.com/aws-amplify/amplify-backend
  - ソースコードはここです
- https://docs.amplify.aws/vue/how-amplify-works/concepts/
  - 公式ドキュメントです
- https://aws-amplify.github.io/amplify-backend/index.html
  - AWSリソースの実装でめっちゃ使えます！

# まとめ


**おわり**
