---
title: "CloudFormationã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰å¾Œã«CLIã‚’å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS, CloudFormation]
published: false
---

# ç´ æ•µãªã‚‚ã®ã‚’è¦‹ã¤ã‘ã¦ã—ã¾ã£ãŸ

CDK ã¨ã‹ serverless framework ã¨ã‹ã§ã ã„ã¶ CloudFormation ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç°¡å˜ã«ãªã£ã¦ããŸæ˜¨ä»Šã€å€‹äººçš„ã«å¬‰ã—ã„ç´ æ•µãªæ©Ÿèƒ½ãŒ CloudFormationã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

ãã‚ŒãŒ **CommandRunner** ã§ã™ã€‚

ã¾ã æ­£å¼ãªæ©Ÿèƒ½ã§ã¯ãªã„ãŸã‚ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€CloudFormation ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰å¾Œã«Bashã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãªã®ã§ä¾‹ãˆã°ã€CloudFormationã®ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã« Lambda ã‚’å®Ÿè¡Œã—ãŸã„ã¨ã„ã£ãŸãƒ‹ãƒ¼ã‚ºã«ç­”ãˆã¦ãã‚Œã¾ã™ã€‚

ã¡ãªã¿ã«ä»•çµ„ã¿ã¯ Amazon Linux 2 ã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ã®è‡ªç”±åº¦ã¯é«˜ã„ã§ã™ã€‚ãªãŠã€Lambdaã˜ã‚ƒãªã„ç†ç”±ã¯ã€Lambda ãŒ Bash ã®ä½¿ç”¨ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã‹ã‚‰ã ãã†ã§ã™ã€‚

# å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹

## Install

```bash
git clone https://github.com/aws-cloudformation/aws-cloudformation-resource-providers-awsutilities-commandrunner.git
cd aws-cloudformation-resource-providers-awsutilities-commandrunner
curl -LO https://github.com/aws-cloudformation/aws-cloudformation-resource-providers-awsutilities-commandrunner/releases/latest/download/awsutility-cloudformation-commandrunner.zip
./scripts/register.sh --set-default
```

[Github](https://github.com/aws-cloudformation/aws-cloudformation-resource-providers-awsutilities-commandrunner) ã«è¨˜è¼‰ã®é€šã‚Šã«ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

`--set-default` ã“ã¡ã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®éƒ¨åˆ†ã§ã€AWS CLIã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ãªãŠã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€AWS SSOãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€CommandRunnerç”¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç”¨æ„ã—ã¦ã‚‚ã„ã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆSSOãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€`/.aws` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ã‚ã‚‹èªè¨¼æƒ…å ±ã®å ´æ‰€ãŒé•ã†ã“ã¨ãŒåŸå› ã‹ã¨æ€ã„ã¾ã™ï¼‰ã€‚

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€CommandRunner ã«å¿…è¦ãªIAMãƒ­ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

ãã®ã‚ã¨ã« CommandRunner ãŒåˆ©ç”¨ã™ã‚‹ `ec2.amazonaws.com` ã‚’ä¿¡é ¼é–¢ä¿‚ã¨ã—ãŸIAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®IAMãƒ­ãƒ¼ãƒ«ã¯ CommandRunner ãŒç«‹ã¡ä¸Šã’ãŸEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¦ä½¿ç”¨ã•ã‚Œã‚‹ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ­ãƒ¼ãƒ«éƒ¨åˆ†ã«ã¯ã“ã¡ã‚‰ã®ARNã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

ãªãŠã“ã® IAMãƒ­ãƒ¼ãƒ« ã«ã¯ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

```bash
"logs:CreateLogStream",
"logs:CreateLogGroup",
"logs:PutLogEvents"
```

ã“ã‚Œã§æº–å‚™å®Œäº†ã§ã™ã€‚

## å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹

Serverless Framework ã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã—ãŸã€‚

```yaml
service: commandrunner-demo
frameworkVersion: '2'

provider:
  name: aws
  region: ap-northeast-1

resources:
  Resources:
    MySNSTopic:
      # ãƒªã‚½ãƒ¼ã‚¹ã®å‰ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã“ã“ã« DependsOn ã‚’è¿½è¨˜ã™ã‚‹
      # DependsOn: Command  
      Type: AWS::SNS::Topic
      Properties:
        TopicName: "SampleTopic"

    Command:
      # ãƒªã‚½ãƒ¼ã‚¹ã®å¾Œã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã“ã“ã« DependsOn ã‚’è¿½è¨˜ã™ã‚‹
      # DependsOn: MySNSTopic  
      Type: AWSUtility::CloudFormation::CommandRunner
      Properties:
        Command: 'aws sns list-topics --region ap-northeast-1 > /command-output.txt'
        Role: arn:aws:iam::${AWS_ACCOUNT_ID}:role/CommandRunnerRole

  Outputs:
      Output:
          Description: The output of the CommandRunner.
          Value: !GetAtt Command.Output
```

`Role` ã®éƒ¨åˆ†ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

å®Ÿéš›ã« `sls deploy` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€CommandRunnerãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã€ã‚ã‹ã£ãŸã“ã¨ã‚„ç‰¹å¾´ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

- AWS CLIã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã¯ `--region` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚S3ã®ã‚ˆã†ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã¯ãªãã¦ã‚‚ã„ã„ã§ã™ã€‚
- ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚„ã‚µãƒ–ãƒãƒƒãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã¨ã¯åˆ¥ã«ã€CommandRunnerç”¨ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒèµ·å‹•ã—ã¾ã™ã€‚
- CommandRunnerç”¨ã®ã‚¹ã‚¿ãƒƒã‚¯ã¯ã€EC2ä½œã£ãŸã‚Šã„ã‚ã„ã‚ã—ãŸã‚Šã—ã¦ã„ã‚‹ã®ã§ï¼‘è¡Œã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚‚å®Ÿè¡Œå®Œäº†ã¾ã§ãŒé•·ã„ã€‚
- ã‚µãƒ–ãƒãƒƒãƒˆã‚’æŒ‡å®šã—ãªã‘ã‚Œã°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®VPCã«EC2ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ã‚µãƒ–ãƒãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚æŒ‡å®šã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

## Output

```yaml
Resources:
  Command:
    Type: AWSUtility::CloudFormation::CommandRunner
    Properties:
      Command: aws s3 ls > /command-output.txt
      Role: String

Outputs:
    Output:
        Description: The output of the CommandRunner.
        Value: !GetAtt Command.Output
```

ã‚³ãƒãƒ³ãƒ‰ã®çµæœã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ã« `/command-output.txt` ã‚’å‡ºåŠ›å…ˆã«ã™ã‚‹ã“ã¨ã§ã€CloudFormation ã®å‡ºåŠ›éƒ¨åˆ†ã«æ®‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## troubleshooting

> WaitCondition timed out. Received 0 conditions when expecting 1

ä¸Šè¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒã€CommandRunnerç”¨ã®ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰è¦‹ã‚‰ã‚ŒãŸå ´åˆã€